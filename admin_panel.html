<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - User Management</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: white;
      padding: 30px;
      border-radius: 12px;
      margin-bottom: 30px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .header h1 {
      color: #1e293b;
      margin-bottom: 10px;
    }

    .header .user-info {
      color: #64748b;
      font-size: 14px;
    }

    .card {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    }

    .stat-value {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 0.875rem;
      opacity: 0.9;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }

    th {
      background: #f8fafc;
      font-weight: 600;
      color: #1e293b;
    }

    .role-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .role-admin {
      background: #fee2e2;
      color: #991b1b;
    }

    .role-premium {
      background: #fef3c7;
      color: #92400e;
    }

    .role-standard {
      background: #e0e7ff;
      color: #3730a3;
    }

    .mode-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .mode-text {
      background: #dbeafe;
      color: #1d4ed8;
    }

    .mode-image {
      background: #dcfce7;
      color: #15803d;
    }

    .mode-hybrid {
      background: #ede9fe;
      color: #6d28d9;
    }

    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
    }

    button:hover {
      background: #2563eb;
    }

    button:disabled {
      background: #94a3b8;
      cursor: not-allowed;
    }

    button.danger {
      background: #ef4444;
    }

    button.danger:hover {
      background: #dc2626;
    }

    .status {
      margin-top: 20px;
      margin-bottom: 16px;
      padding: 15px;
      border-radius: 8px;
      font-size: 14px;
    }

    .status.loading {
      background: #fef3c7;
      border-left: 4px solid #f59e0b;
    }

    .status.success {
      background: #d1fae5;
      border-left: 4px solid #10b981;
    }

    .status.error {
      background: #fee2e2;
      border-left: 4px solid #ef4444;
    }

    .status.hint {
      background: #dcfce7;
      border-left: 4px solid #22c55e;
      color: #065f46;
    }

    .api-usage {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      background: #ecfeff;
      border-left: 4px solid #06b6d4;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 13px;
      margin-bottom: 18px;
    }

    .api-usage strong {
      color: #0f172a;
    }

    .api-usage .api-split {
      margin-left: 10px;
      color: #475569;
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 16px;
    }

    .filters label {
      font-size: 12px;
      color: #475569;
      margin-right: 6px;
    }

    .filters select,
    .filters input {
      padding: 6px 10px;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      font-size: 13px;
      background: #fff;
    }

    .filters .filter-group {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 12px;
      max-width: 500px;
      width: 90%;
    }

    .modal-content h2 {
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #1e293b;
    }

    .form-group select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      font-size: 14px;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .login-section {
      text-align: center;
      padding: 60px 20px;
    }

    .login-section button {
      padding: 15px 30px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Login section -->
    <div id="loginSection" class="card login-section" style="display: none;">
      <h1 style="margin-bottom: 20px;">üîê Admin Panel</h1>
      <p style="margin-bottom: 30px; color: #64748b;">Prihl√°ste sa pre pr√≠stup k admin panelu</p>
      <button onclick="loginWithGoogle()">Prihl√°si≈• sa cez Google</button>
      <div id="loginStatus" class="status" style="display: none;"></div>
    </div>

    <!-- Admin panel -->
    <div id="adminPanel" style="display: none;">
      <div class="header">
        <h1>üëë Admin Panel</h1>
        <div class="user-info">
          Prihl√°sen√Ω ako: <strong id="adminEmail"></strong>
          <button onclick="refreshExchangeRatesNow()" style="margin-left: 20px; background: #0ea5e9;">üîÑ Aktualizova≈• kurzov√Ω l√≠stok</button>
          <button id="grantAdminBtn" onclick="ensureAdminRole()" style="margin-left: 10px; background: #111827; display: none;">üß™ Nastavi≈• admin rolu</button>
          <button onclick="window.location.href='/'" style="margin-left: 10px; background: #3b82f6;">‚Üê Sp√§≈• na zbierku</button><button onclick="window.location.href='/admin_logs.html'" style="margin-left: 10px; background: #10b981;">üìã Hist√≥ria aktualiz√°ci√≠</button>
          <button onclick="logout()" style="margin-left: 10px; background: #ef4444;">Odhl√°si≈• sa</button>
        </div>
      </div>

      <div id="status" class="status hint">‚ÑπÔ∏è Tu sa zobrazia inform√°cie o aktualiz√°ci√°ch, chyb√°ch a priebehu spracovania.</div>
      <div class="api-usage">
        <div>
          <strong>eBay API dnes:</strong>
          <span id="apiCallsToday">0</span> / <span id="apiDailyBudget">0</span>
          <span class="api-split">Zost√°va: <span id="apiCallsRemaining">0</span></span>
          <span class="api-split">Text: <span id="apiCallsText">0</span></span>
          <span class="api-split">Foto: <span id="apiCallsImage">0</span></span>
          <span class="api-split">D√°tum: <span id="apiUsageDate">-</span></span>
        </div>
        <button onclick="loadApiUsage()" style="background:#06b6d4;">üîÑ Obnovi≈• API</button>
      </div>

      <!-- Statistics -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="totalUsers">0</div>
          <div class="stat-label">Celkom userov</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
          <div class="stat-value" id="premiumUsers">0</div>
          <div class="stat-label">Premium userov</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
          <div class="stat-value" id="totalCards">0</div>
          <div class="stat-label">Celkom polo≈æiek</div>
        </div>
      </div>

      <!-- Users table -->
      <div class="card">
        <h2 style="margin-bottom: 20px;">Pou≈æ√≠vatelia</h2>
        <div class="filters">
          <button onclick="loadUsers()">üîÑ Obnovi≈•</button>
          <div class="filter-group">
            <label for="userRoleFilter">Rola:</label>
            <select id="userRoleFilter" onchange="applyUserFilters()">
              <option value="">V≈°etci</option>
              <option value="standard">Standard</option>
              <option value="premium">Premium</option>
              <option value="admin">Admin</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="userModeFilter">Re≈æim:</label>
            <select id="userModeFilter" onchange="applyUserFilters()">
              <option value="">V≈°etky</option>
              <option value="text">Text</option>
              <option value="image">Foto</option>
              <option value="hybrid">Hybrid</option>
            </select>
          </div>
        </div>

        <div style="overflow-x: auto;">
          <table id="usersTable">
            <thead>
              <tr>
                <th>Email</th>
                <th>Rola</th>
                <th>Ceny</th>
                <th>Polo≈æky</th>
                <th>Limit</th>
                <th>Update interval</th>
                <th>Posledn√Ω update</th>
                <th>Najbli≈æ≈°√≠ update</th>
                <th>Email notif.</th>
                <th>Registr√°cia</th>
                <th>Akcie</th>
              </tr>
            </thead>
            <tbody id="usersTableBody">
              <tr>
                <td colspan="11" style="text-align: center; color: #94a3b8;">
                  Naƒç√≠tavam pou≈æ√≠vateƒæov...
                </td>
              </tr>
            </tbody>
          </table>
        </div>

      </div>

      <!-- Update Logs Section -->
      <div class="card" style="margin-top: 30px;">
        <h2 style="margin-bottom: 20px;">üìã Hist√≥ria aktualiz√°ci√≠</h2>
        <div class="filters">
          <button onclick="loadUpdateLogs({reset: true})">üîÑ Obnovi≈•</button>
          <div class="filter-group">
            <label for="logUserFilter">Pou≈æ√≠vateƒæ:</label>
            <select id="logUserFilter" onchange="applyLogFilters()">
              <option value="">V≈°etci</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="logTypeFilter">Typ:</label>
            <select id="logTypeFilter" onchange="applyLogFilters()">
              <option value="">V≈°etky</option>
              <option value="manual">Manual</option>
              <option value="scheduled">Scheduled</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="logModeFilter">Re≈æim:</label>
            <select id="logModeFilter" onchange="applyLogFilters()">
              <option value="">V≈°etky</option>
              <option value="text">Text</option>
              <option value="image">Foto</option>
              <option value="hybrid">Hybrid</option>
            </select>
          </div>
        </div>

        <div style="overflow-x: auto;">
          <table id="updateLogsTable">
            <thead>
              <tr>
                <th>D√°tum</th>
                <th>Pou≈æ√≠vateƒæ</th>
                <th>Spracovan√©</th>
                <th>√öspe≈°n√©</th>
                <th>Chyby</th>
                <th>Typ</th>
                <th>Export JSON</th>
              </tr>
            </thead>
            <tbody id="updateLogsTableBody">
              <tr>
                <td colspan="7" style="text-align: center; color: #94a3b8;">
                  Naƒç√≠tavam hist√≥riu...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <button id="loadMoreLogsBtn" onclick="loadMoreLogs()" style="margin-top: 12px; display: none;">Naƒç√≠ta≈• ƒèal≈°ie</button>
      </div>
    </div>
  </div>

  <!-- Change Role Modal -->
  <div id="roleModal" class="modal">
    <div class="modal-content">
      <h2>Zmeni≈• rolu pou≈æ√≠vateƒæa</h2>
      <p style="margin-bottom: 20px; color: #64748b;" id="modalUserEmail"></p>

      <div class="form-group">
        <label>Nov√° rola:</label>
        <select id="newRoleSelect">
          <option value="standard">Standard (20 polo≈æiek, 1x update/mesiac)</option>
          <option value="premium">Premium (neobmedzen√©, 2x update/mesiac)</option>
          <option value="admin">Admin (neobmedzen√©, 2x update/mesiac + admin pr√≠stup)</option>
        </select>
      </div>

      <div class="modal-actions">
        <button onclick="closeModal()">Zru≈°i≈•</button>
        <button onclick="confirmRoleChange()">Ulo≈æi≈•</button>
      </div>
    </div>
  </div>

  <!-- Change Pricing Mode Modal -->
  <div id="pricingModeModal" class="modal">
    <div class="modal-content">
      <h2>Zmeni≈• sp√¥sob aktualiz√°cie cien</h2>
      <p style="margin-bottom: 20px; color: #64748b;" id="pricingModalUserEmail"></p>

      <div class="form-group">
        <label>Sp√¥sob:</label>
        <select id="pricingModeSelect">
          <option value="text">Text (n√°zov karty)</option>
          <option value="image">Foto (obr√°zok karty)</option>
          <option value="hybrid">Hybrid (text + foto)</option>
        </select>
      </div>

      <div class="modal-actions">
        <button onclick="closePricingModeModal()">Zru≈°i≈•</button>
        <button onclick="confirmPricingModeChange()">Ulo≈æi≈•</button>
      </div>
    </div>
  </div>

  <!-- Edit Next Update Modal -->
  <div id="updateDateModal" class="modal">
    <div class="modal-content">
      <h2>Zmeni≈• d√°tum najbli≈æ≈°ej aktualiz√°cie</h2>
      <p style="margin-bottom: 20px; color: #64748b;" id="modalUpdateUserEmail"></p>

      <div class="form-group">
        <label>Nov√Ω d√°tum a ƒças:</label>
        <input type="datetime-local" id="newUpdateDateInput" style="width: 100%; padding: 10px 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 14px;">
      </div>

      <div class="modal-actions">
        <button onclick="closeUpdateDateModal()">Zru≈°i≈•</button>
        <button onclick="confirmUpdateDateChange()">Ulo≈æi≈•</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, doc, getDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { getFunctions, httpsCallable } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js';

    const isTest = window.location.hostname.includes('your-card-collection-2026-test');
    const isAllowlistedAdmin = (email) =>
      isTest && ['miroslav.svajda@gmail.com'].includes((email || '').toLowerCase());
    const firebaseConfig = isTest
      ? {
          apiKey: "AIzaSyAKAr3NdF7VUtoajv9mtiitjXZPStuR0oY",
          authDomain: "your-card-collection-2026-test.firebaseapp.com",
          projectId: "your-card-collection-2026-test",
          storageBucket: "your-card-collection-2026-test.firebasestorage.app",
          messagingSenderId: "419835800440",
          appId: "1:419835800440:web:0ef4cd6572ce21afca768d"
        }
      : {
          apiKey: "AIzaSyBlAhlya-NNp8gCxGPBIPxxCgDa6l9AXo8",
          authDomain: "your-card-collection-2026.firebaseapp.com",
          projectId: "your-card-collection-2026",
          storageBucket: "your-card-collection-2026.firebasestorage.app",
          messagingSenderId: "620171462959",
          appId: "1:620171462959:web:28ecb209a009d16db679da"
        };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const functions = getFunctions(app, 'us-central1');
    const googleProvider = new GoogleAuthProvider();
    const STATUS_HINT = '‚ÑπÔ∏è Tu sa zobrazia inform√°cie o aktualiz√°ci√°ch, chyb√°ch a priebehu spracovania.';

    let currentUser = null;
    let selectedUserId = null;
    let selectedPricingUserId = null;
    let allUsers = [];
    let updateLogsCursor = null;
    const UPDATE_LOGS_LIMIT = 20;
    const grantAdminBtn = document.getElementById('grantAdminBtn');

    function resetStatusHint() {
      const status = document.getElementById('status');
      if (!status) return;
      status.className = 'status hint';
      status.innerHTML = STATUS_HINT;
    }

    if (isTest && grantAdminBtn) {
      grantAdminBtn.style.display = 'inline-block';
    }

    // Auth state observer
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        document.getElementById('loginSection').style.display = 'block';
        document.getElementById('adminPanel').style.display = 'none';
        return;
      }

      currentUser = user;

      // Check if user is admin
      const userDoc = await getDoc(doc(db, 'users', user.uid));
      const isAdmin = isAllowlistedAdmin(user.email) || (userDoc.exists() && userDoc.data().role === 'admin');
      if (!isAdmin) {
        const loginStatus = document.getElementById('loginStatus');
        loginStatus.className = 'status error';
        loginStatus.style.display = 'block';
        loginStatus.innerHTML = '<strong>‚ùå Pr√≠stup zamietnut√Ω</strong><br>Nem√°te admin opr√°vnenia.';
        return;
      }

      // Show admin panel
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('adminPanel').style.display = 'block';
      document.getElementById('adminEmail').textContent = user.email;

      // Load users
      await loadUsers();
      await loadUpdateLogs({reset: true});
      await loadApiUsage();
    });

    window.loginWithGoogle = async function() {
      const status = document.getElementById('loginStatus');
      try {
        status.className = 'status loading';
        status.style.display = 'block';
        status.innerHTML = '<strong>‚è≥ Prihlasovanie...</strong>';
        await signInWithPopup(auth, googleProvider);
      } catch (error) {
        console.error('Login error:', error);
        status.className = 'status error';
        status.innerHTML = `<strong>‚ùå Chyba pri prihl√°sen√≠:</strong><br><code>${error.message}</code>`;
      }
    };

    window.logout = async function() {
      await signOut(auth);
    };

    window.ensureAdminRole = async function() {
      const status = document.getElementById('status');
      status.className = 'status loading';
      status.innerHTML = '<strong>‚è≥ Nastavujem admin rolu...</strong>';
      try {
        const grantAdmin = httpsCallable(functions, 'grantAdminRoleV2');
        const result = await grantAdmin();
        status.className = 'status success';
        status.innerHTML = `<strong>‚úÖ Admin rola nastaven√°</strong><br>${JSON.stringify(result.data || {})}`;
      } catch (error) {
        console.error('Grant admin error:', error);
        status.className = 'status error';
        status.innerHTML = `<strong>‚ùå Chyba:</strong><br><code>${error.message}</code>`;
      }
    };

    window.loadUsers = async function() {
      const status = document.getElementById('status');
      const tbody = document.getElementById('usersTableBody');

      status.className = 'status loading';
      status.innerHTML = '<strong>üîÑ Naƒç√≠tavam pou≈æ√≠vateƒæov...</strong>';

      try {
        const getAllUsers = httpsCallable(functions, 'getAllUsersV2');
        const result = await getAllUsers();
        const users = result.data.users || [];
        allUsers = users;
        populateUserFilter(users);
        renderUsers();

        status.className = 'status success';
        status.innerHTML = `<strong>‚úÖ Naƒç√≠tan√Ωch ${users.length} pou≈æ√≠vateƒæov</strong>`;
        setTimeout(resetStatusHint, 3000);
      } catch (error) {
        console.error('Error loading users:', error);
        status.className = 'status error';
        status.innerHTML = `<strong>‚ùå Chyba:</strong> ${error.message}`;
      }
    };

    function populateUserFilter(users) {
      const select = document.getElementById('logUserFilter');
      if (!select) return;
      const currentValue = select.value;
      const options = ['<option value=\"\">V≈°etci</option>'];
      users.forEach(user => {
        const email = user.email || user.displayName || user.id;
        if (email) {
          options.push(`<option value=\"${email}\">${email}</option>`);
        }
      });
      select.innerHTML = options.join('');
      if (currentValue && select.querySelector(`option[value=\"${currentValue}\"]`)) {
        select.value = currentValue;
      }
    }

    function renderUsers() {
      const tbody = document.getElementById('usersTableBody');
      const roleFilter = document.getElementById('userRoleFilter')?.value || '';
      const modeFilter = document.getElementById('userModeFilter')?.value || '';
      const filtered = allUsers.filter(u => {
        if (roleFilter && u.role !== roleFilter) return false;
        if (modeFilter && (u.pricingMode || 'text') !== modeFilter) return false;
        return true;
      });

      document.getElementById('totalUsers').textContent = filtered.length;
      document.getElementById('premiumUsers').textContent = filtered.filter(u => u.role === 'premium').length;
      const totalCards = filtered.reduce((sum, u) => sum + (Number(u.currentCardCount) || 0), 0);
      document.getElementById('totalCards').textContent = totalCards;

      tbody.innerHTML = '';
      filtered.forEach(user => {
        const tr = document.createElement('tr');
        const nextUpdate = user.nextUpdateDate ? new Date(user.nextUpdateDate).toLocaleString('sk-SK') : 'N/A';
        const lastUpdate = user.lastCollectionUpdate ? new Date(user.lastCollectionUpdate).toLocaleString('sk-SK') : '‚Äî';
        const pricingMode = user.pricingMode || 'text';
        const pricingLabel = pricingMode === 'image'
          ? 'FOTO'
          : (pricingMode === 'hybrid' ? 'HYBRID' : 'TEXT');
        const intervalDisplay = user.updateIntervalDays > 0 ? `${user.updateIntervalDays} dn√≠` : '‚Äî';
        tr.innerHTML = `
          <td>${user.email || user.displayName || user.id}</td>
          <td><span class="role-badge role-${user.role}">${user.role}</span></td>
          <td><span class="mode-badge mode-${pricingMode}">${pricingLabel}</span></td>
          <td><strong>${user.currentCardCount}</strong></td>
          <td>${user.cardLimit === 999999 ? '‚àû' : user.cardLimit}</td>
          <td>${intervalDisplay}</td>
          <td>${lastUpdate}</td>
          <td>
            ${nextUpdate}
            <button onclick="openUpdateDateModal('${user.id}', '${user.email}', '${user.nextUpdateDate || ''}')" style="margin-left: 5px; padding: 4px 8px; font-size: 12px;">‚úèÔ∏è</button>
          </td>
          <td>
            <button onclick="toggleEmailNotif('${user.id}', ${!user.emailNotifications})" style="background: ${user.emailNotifications ? '#10b981' : '#64748b'}; font-size: 11px; padding: 4px 10px;">
              ${user.emailNotifications ? 'ON' : 'OFF'}
            </button>
          </td>
          <td>${user.createdAt ? new Date(user.createdAt).toLocaleDateString('sk-SK') : 'N/A'}</td>
          <td>
            <button id="updateBtn-${user.id}" onclick="triggerUpdateNow('${user.id}', '${user.email}', this)" style="background: #10b981; margin-bottom: 5px;">‚ñ∂Ô∏è Spusti≈• update</button><br>
            <button onclick="openRoleModal('${user.id}', '${user.email}', '${user.role}')">Zmeni≈• rolu</button><br>
            <button onclick="openPricingModeModal('${user.id}', '${user.email}', '${pricingMode}')" style="margin-top: 5px; background: #0ea5e9;">Zmeni≈• m√≥d</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    window.applyUserFilters = function() {
      renderUsers();
    };

    function escapeHtml(value) {
      return String(value ?? '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/\"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function buildLogFilters() {
      return {
        userEmail: document.getElementById('logUserFilter')?.value || '',
        triggerType: document.getElementById('logTypeFilter')?.value || '',
        pricingMode: document.getElementById('logModeFilter')?.value || '',
      };
    }

    window.applyLogFilters = function() {
      updateLogsCursor = null;
      window.loadUpdateLogs({reset: true});
    };

    window.loadMoreLogs = function() {
      window.loadUpdateLogs({append: true});
    };

    window.loadUpdateLogs = async function(options = {}) {
      const tbody = document.getElementById('updateLogsTableBody');
      const loadMoreBtn = document.getElementById('loadMoreLogsBtn');
      const isReset = options.reset || false;
      const isAppend = options.append || false;

      if (!isAppend) {
        tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; color: #94a3b8;">Naƒç√≠tavam hist√≥riu...</td></tr>`;
      }

      try {
        const getUpdateLogs = httpsCallable(functions, 'getUpdateLogsV2');
        const result = await getUpdateLogs({
          limit: UPDATE_LOGS_LIMIT,
          filters: buildLogFilters(),
          startAfter: updateLogsCursor,
        });
        const logs = result.data?.logs || [];
        const nextPageToken = result.data?.nextPageToken || null;

        if (!logs.length) {
          if (!isAppend) {
            tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; color: #94a3b8;">≈Ωiadne z√°znamy</td></tr>`;
          }
          if (loadMoreBtn) loadMoreBtn.style.display = 'none';
          return;
        }

        if (!isAppend) {
          tbody.innerHTML = '';
          window.updateLogsIndex = {};
        }
        logs.forEach(log => {
          const tr = document.createElement('tr');
          const date = log.timestamp ? new Date(log.timestamp).toLocaleString('sk-SK') : 'N/A';
          const userLabel = log.userEmail || log.userId || 'N/A';
          const processed = log.totalCards ?? 0;
          const success = log.successCount ?? 0;
          const fail = log.failCount ?? 0;
          const typeLabel = `${log.triggerType || log.status || 'n/a'}${log.pricingMode ? ` / ${log.pricingMode}` : ''}`;

          window.updateLogsIndex = window.updateLogsIndex || {};
          window.updateLogsIndex[log.id] = log;

          tr.innerHTML = `
            <td>${date}</td>
            <td>${userLabel}</td>
            <td>${processed}</td>
            <td>${success}</td>
            <td>${fail}</td>
            <td>${typeLabel}</td>
            <td><button onclick="exportUpdateLog('${log.id}')" style="background:#0ea5e9;">‚¨áÔ∏è Export JSON</button></td>
          `;
          tbody.appendChild(tr);
        });

        updateLogsCursor = nextPageToken;
        if (loadMoreBtn) {
          loadMoreBtn.style.display = updateLogsCursor ? 'inline-block' : 'none';
        }
      } catch (error) {
        console.error('Error loading update logs:', error);
        if (!isAppend) {
          tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; color: #ef4444;">Chyba: ${error.message}</td></tr>`;
        }
        if (loadMoreBtn) loadMoreBtn.style.display = 'none';
      }
    };

    window.loadApiUsage = async function() {
      try {
        const getApiUsage = httpsCallable(functions, 'getApiUsageV2');
        const result = await getApiUsage();
        const usage = result.data?.usage || {};

        const callsToday = usage.callsToday ?? 0;
        const dailyBudget = usage.dailyBudget ?? 0;
        const remaining = usage.remaining ?? Math.max(0, dailyBudget - callsToday);
        const byType = usage.byType || {};

        document.getElementById('apiCallsToday').textContent = callsToday;
        document.getElementById('apiDailyBudget').textContent = dailyBudget;
        document.getElementById('apiCallsRemaining').textContent = remaining;
        document.getElementById('apiCallsText').textContent = byType.text ?? 0;
        document.getElementById('apiCallsImage').textContent = byType.image ?? 0;
        document.getElementById('apiUsageDate').textContent = usage.date || '-';
      } catch (error) {
        console.error('Error loading API usage:', error);
      }
    };

    function safeFilename(value) {
      return String(value || "unknown")
        .replace(/[^a-z0-9_-]+/gi, "_")
        .replace(/^_+|_+$/g, "")
        .slice(0, 60);
    }

    window.exportUpdateLog = function(logId) {
      const log = window.updateLogsIndex?.[logId];
      if (!log) {
        alert('Log nebol n√°jden√Ω');
        return;
      }

      const payload = {
        ...log,
        exportedAt: new Date().toISOString(),
      };

      const json = JSON.stringify(payload, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);

      const emailPart = safeFilename(log.userEmail || log.userId || 'user');
      const datePart = safeFilename(log.timestamp || new Date().toISOString());
      const filename = `update-log_${emailPart}_${datePart}.json`;

      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    };

    window.openRoleModal = function(userId, email, currentRole) {
      selectedUserId = userId;
      document.getElementById('modalUserEmail').textContent = email;
      document.getElementById('newRoleSelect').value = currentRole;
      document.getElementById('roleModal').classList.add('active');
    };

    window.closeModal = function() {
      document.getElementById('roleModal').classList.remove('active');
      selectedUserId = null;
    };

    window.confirmRoleChange = async function() {
      if (!selectedUserId) return;

      const newRole = document.getElementById('newRoleSelect').value;
      const status = document.getElementById('status');

      status.className = 'status loading';
      status.innerHTML = '<strong>‚è≥ Men√≠m rolu...</strong>';

      try {
        const updateUserRole = httpsCallable(functions, 'updateUserRoleV2');
        await updateUserRole({ targetUserId: selectedUserId, newRole: newRole });

        status.className = 'status success';
        status.innerHTML = `<strong>‚úÖ Rola √∫spe≈°ne zmenen√° na ${newRole}</strong>`;

        closeModal();
        await loadUsers();

        setTimeout(resetStatusHint, 3000);
      } catch (error) {
        console.error('Error updating role:', error);
        status.className = 'status error';
        status.innerHTML = `<strong>‚ùå Chyba:</strong> ${error.message}`;
      }
    };

    window.openPricingModeModal = function(userId, email, currentMode) {
      selectedPricingUserId = userId;
      document.getElementById('pricingModalUserEmail').textContent = email;
      document.getElementById('pricingModeSelect').value = currentMode || 'text';
      document.getElementById('pricingModeModal').classList.add('active');
    };

    window.closePricingModeModal = function() {
      document.getElementById('pricingModeModal').classList.remove('active');
      selectedPricingUserId = null;
    };

    window.confirmPricingModeChange = async function() {
      if (!selectedPricingUserId) return;

      const newMode = document.getElementById('pricingModeSelect').value;
      const status = document.getElementById('status');

      status.className = 'status loading';
      status.innerHTML = '<strong>‚è≥ Men√≠m sp√¥sob aktualiz√°cie cien...</strong>';

      try {
        const updatePricingMode = httpsCallable(functions, 'updatePricingModeV2');
        await updatePricingMode({ targetUserId: selectedPricingUserId, pricingMode: newMode });

        status.className = 'status success';
        status.innerHTML = `<strong>‚úÖ Sp√¥sob aktualiz√°cie nastaven√Ω na ${newMode}</strong>`;

        closePricingModeModal();
        await loadUsers();

        setTimeout(resetStatusHint, 3000);
      } catch (error) {
        console.error('Error updating pricing mode:', error);
        status.className = 'status error';
        status.innerHTML = `<strong>‚ùå Chyba:</strong> ${error.message}`;
      }
    };

    // Email Notifications Toggle
    window.toggleEmailNotif = async function(userId, enabled) {
      const status = document.getElementById('status');
      status.className = 'status loading';
      status.innerHTML = `<strong>‚è≥ ${enabled ? 'Zap√≠nam' : 'Vyp√≠nam'} email notifik√°cie...</strong>`;

      try {
        const toggleFn = httpsCallable(functions, 'toggleEmailNotificationsV2');
        await toggleFn({ targetUserId: userId, enabled });

        status.className = 'status success';
        status.innerHTML = `<strong>‚úÖ Email notifik√°cie ${enabled ? 'zapnut√©' : 'vypnut√©'}</strong>`;
        await loadUsers();
        setTimeout(resetStatusHint, 3000);
      } catch (error) {
        console.error('Error toggling email notifications:', error);
        status.className = 'status error';
        status.innerHTML = `<strong>‚ùå Chyba:</strong> ${error.message}`;
      }
    };

    // Update Date Modal functions
    window.openUpdateDateModal = function(userId, email, currentDate) {
      selectedUserId = userId;
      document.getElementById('modalUpdateUserEmail').textContent = email;

      // Convert Firebase timestamp to datetime-local format
      if (currentDate) {
        const date = new Date(currentDate);
        const localDatetime = new Date(date.getTime() - date.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
        document.getElementById('newUpdateDateInput').value = localDatetime;
      }

      document.getElementById('updateDateModal').classList.add('active');
    };

    window.closeUpdateDateModal = function() {
      document.getElementById('updateDateModal').classList.remove('active');
      selectedUserId = null;
    };

    window.confirmUpdateDateChange = async function() {
      if (!selectedUserId) return;

      const newDatetime = document.getElementById('newUpdateDateInput').value;
      if (!newDatetime) {
        alert('Pros√≠m vyber d√°tum a ƒças');
        return;
      }

      const status = document.getElementById('status');

      status.className = 'status loading';
      status.innerHTML = '<strong>‚è≥ Men√≠m d√°tum aktualiz√°cie...</strong>';

      try {
        const updateNextUpdateDate = httpsCallable(functions, 'updateNextUpdateDateV2');
        await updateNextUpdateDate({
          targetUserId: selectedUserId,
          nextUpdateDate: new Date(newDatetime).toISOString()
        });

        status.className = 'status success';
        status.innerHTML = `<strong>‚úÖ D√°tum aktualiz√°cie √∫spe≈°ne zmenen√Ω</strong>`;

        closeUpdateDateModal();
        await loadUsers();

        setTimeout(resetStatusHint, 3000);
      } catch (error) {
        console.error('Error updating date:', error);
        status.className = 'status error';
        status.innerHTML = `<strong>‚ùå Chyba:</strong> ${error.message}`;
      }
    };

    // Trigger update now function
    window.triggerUpdateNow = async function(userId, email, btn) {
      const status = document.getElementById('status');
      const button = btn || document.getElementById(`updateBtn-${userId}`);
      if (button) {
        button.disabled = true;
        button.dataset.originalLabel = button.dataset.originalLabel || button.textContent;
        button.textContent = '‚è≥ Update spusten√Ω';
      }

      status.className = 'status loading';
      status.innerHTML = `<strong>‚è≥ Sp√∫≈°≈•am aktualiz√°ciu pre ${email}...</strong>`;

      // Start listening to status BEFORE calling the function
      const statusRef = doc(db, 'updateStatus', userId);
      let unsubscribe = null;

      unsubscribe = onSnapshot(statusRef, (docSnap) => {
        if (!docSnap.exists()) return;

        const statusData = docSnap.data();

        if (statusData.status === 'processing') {
          status.className = 'status loading';
          status.innerHTML = `
            <strong>‚è≥ Aktualiz√°cia prebieha...</strong><br>
            Email: ${email}<br>
            Spracovan√©: ${statusData.successCount + statusData.failCount} / ${statusData.cardsProcessed || '?'}<br>
            ‚úì √öspe≈°ne: <strong style="color: #10b981;">${statusData.successCount || 0}</strong><br>
            ${statusData.failCount > 0 ? `‚úó Chyby: <strong style="color: #ef4444;">${statusData.failCount}</strong>` : ''}
          `;
        } else if (statusData.status === 'completed') {
          status.className = 'status success';
          status.innerHTML = `
            <strong>‚úÖ Aktualiz√°cia dokonƒçen√°!</strong><br>
            Email: ${email}<br>
            Celkom polo≈æiek: ${statusData.cardsProcessed || 0}<br>
            ‚úì √öspe≈°ne aktualizovan√Ωch: <strong style="color: #10b981;">${statusData.successCount || 0}</strong><br>
            ${statusData.failCount > 0 ? `‚úó Nepodarilo sa: <strong style="color: #ef4444;">${statusData.failCount}</strong><br>` : ''}
            ${statusData.failCount > 0 ? '<small style="color: #64748b;">Polo≈æky bez v√Ωsledkov z eBay m√¥≈æe≈° upravi≈• manu√°lne v zbierke.</small>' : ''}
          `;

          if (unsubscribe) unsubscribe();

          if (button) {
            button.disabled = false;
            button.textContent = button.dataset.originalLabel || '‚ñ∂Ô∏è Spusti≈• update';
          }

          loadUsers();
          setTimeout(resetStatusHint, 8000);
        } else if (statusData.status === 'error') {
          status.className = 'status error';
          status.innerHTML = `<strong>‚ùå Chyba pri aktualiz√°cii:</strong><br><code>${statusData.error || 'Unknown error'}</code>`;

          if (unsubscribe) unsubscribe();

          if (button) {
            button.disabled = false;
            button.textContent = button.dataset.originalLabel || '‚ñ∂Ô∏è Spusti≈• update';
          }
        }
      });

      try {
        const updateUserCollection = httpsCallable(functions, 'updateUserCollectionV2', {timeout: 3600000});
        await updateUserCollection({ userId: userId });
      } catch (error) {
        // deadline-exceeded is expected for long updates ‚Äî function keeps running server-side
        // Status is tracked via onSnapshot above, so we only show real errors
        if (error.code === 'deadline-exceeded' || error.message?.includes('deadline-exceeded')) {
          console.log('Client timeout (expected for long updates) ‚Äî server continues processing');
          status.className = 'status loading';
          status.innerHTML = `
            <strong>‚è≥ Aktualiz√°cia prebieha na serveri...</strong><br>
            <small>Klientsk√© spojenie vypr≈°alo, ale aktualiz√°cia pokraƒçuje. Sledovanie postupu...</small>
          `;
        } else {
          console.error('Error triggering update:', error);
          status.className = 'status error';
          status.innerHTML = `<strong>‚ùå Chyba pri aktualiz√°cii:</strong><br><code>${error.message}</code>`;
          if (unsubscribe) unsubscribe();
          if (button) {
            button.disabled = false;
            button.textContent = button.dataset.originalLabel || '‚ñ∂Ô∏è Spusti≈• update';
          }
        }
      }
    };

    window.refreshExchangeRatesNow = async function() {
      const status = document.getElementById('status');

      status.className = 'status loading';
      status.innerHTML = '<strong>‚è≥ Aktualizujem ECB kurzy...</strong>';

      try {
        const refreshRates = httpsCallable(functions, 'refreshExchangeRatesNowV2');
        const result = await refreshRates();
        const asOf = result.data?.asOf ? new Date(result.data.asOf).toLocaleDateString('sk-SK') : 'N/A';

        status.className = 'status success';
        status.innerHTML = `<strong>‚úÖ ECB kurzy aktualizovan√©</strong><br>As of: ${asOf}`;
        setTimeout(resetStatusHint, 4000);
      } catch (error) {
        console.error('Error refreshing ECB rates:', error);
        status.className = 'status error';
        status.innerHTML = `<strong>‚ùå Chyba pri aktualiz√°cii kurzov:</strong><br><code>${error.message}</code>`;
      }
    };
  </script>
</body>
</html>
