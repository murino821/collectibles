<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - User Management</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: white;
      padding: 30px;
      border-radius: 12px;
      margin-bottom: 30px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .header h1 {
      color: #1e293b;
      margin-bottom: 10px;
    }

    .header .user-info {
      color: #64748b;
      font-size: 14px;
    }

    .card {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    }

    .stat-value {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 0.875rem;
      opacity: 0.9;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }

    th {
      background: #f8fafc;
      font-weight: 600;
      color: #1e293b;
    }

    .role-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .role-admin {
      background: #fee2e2;
      color: #991b1b;
    }

    .role-premium {
      background: #fef3c7;
      color: #92400e;
    }

    .role-standard {
      background: #e0e7ff;
      color: #3730a3;
    }

    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
    }

    button:hover {
      background: #2563eb;
    }

    button:disabled {
      background: #94a3b8;
      cursor: not-allowed;
    }

    button.danger {
      background: #ef4444;
    }

    button.danger:hover {
      background: #dc2626;
    }

    .status {
      margin-top: 20px;
      padding: 15px;
      border-radius: 8px;
      font-size: 14px;
    }

    .status.loading {
      background: #fef3c7;
      border-left: 4px solid #f59e0b;
    }

    .status.success {
      background: #d1fae5;
      border-left: 4px solid #10b981;
    }

    .status.error {
      background: #fee2e2;
      border-left: 4px solid #ef4444;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 12px;
      max-width: 500px;
      width: 90%;
    }

    .modal-content h2 {
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #1e293b;
    }

    .form-group select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      font-size: 14px;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .login-section {
      text-align: center;
      padding: 60px 20px;
    }

    .login-section button {
      padding: 15px 30px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Login section -->
    <div id="loginSection" class="card login-section" style="display: none;">
      <h1 style="margin-bottom: 20px;">üîê Admin Panel</h1>
      <p style="margin-bottom: 30px; color: #64748b;">Prihl√°ste sa pre pr√≠stup k admin panelu</p>
      <button onclick="loginWithGoogle()">Prihl√°si≈• sa cez Google</button>
      <div id="loginStatus" class="status" style="display: none;"></div>
    </div>

    <!-- Admin panel -->
    <div id="adminPanel" style="display: none;">
      <div class="header">
        <h1>üëë Admin Panel</h1>
        <div class="user-info">
          Prihl√°sen√Ω ako: <strong id="adminEmail"></strong>
          <button onclick="window.location.href='/'" style="margin-left: 20px; background: #3b82f6;">‚Üê Sp√§≈• na zbierku</button><button onclick="window.location.href='/admin_logs.html'" style="margin-left: 10px; background: #10b981;">üìã Hist√≥ria aktualiz√°ci√≠</button>
          <button onclick="logout()" style="margin-left: 10px; background: #ef4444;">Odhl√°si≈• sa</button>
        </div>
      </div>

      <!-- Statistics -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="totalUsers">0</div>
          <div class="stat-label">Celkom userov</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
          <div class="stat-value" id="premiumUsers">0</div>
          <div class="stat-label">Premium userov</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
          <div class="stat-value" id="totalCards">0</div>
          <div class="stat-label">Celkom polo≈æiek</div>
        </div>
      </div>

      <!-- ECB Refresh -->
      <div class="card">
        <h2 style="margin-bottom: 20px;">üí± ECB kurzy</h2>
        <button onclick="refreshExchangeRatesNow()" style="margin-bottom: 10px; background: #0ea5e9;">üîÑ Aktualizova≈• kurzov√Ω l√≠stok</button>
        <div style="font-size: 13px; color: #64748b;">Pou≈æi, ak pravideln√° aktualiz√°cia zlyh√°.</div>
      </div>

      <!-- Users table -->
      <div class="card">
        <h2 style="margin-bottom: 20px;">Pou≈æ√≠vatelia</h2>
        <button onclick="loadUsers()" style="margin-bottom: 20px;">üîÑ Obnovi≈•</button>

        <div style="overflow-x: auto;">
          <table id="usersTable">
            <thead>
              <tr>
                <th>Email</th>
                <th>Rola</th>
                <th>Polo≈æky</th>
                <th>Limit</th>
                <th>Update interval</th>
                <th>Najbli≈æ≈°√≠ update</th>
                <th>Registr√°cia</th>
                <th>Akcie</th>
              </tr>
            </thead>
            <tbody id="usersTableBody">
              <tr>
                <td colspan="8" style="text-align: center; color: #94a3b8;">
                  Naƒç√≠tavam pou≈æ√≠vateƒæov...
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div id="status"></div>
      </div>

      <!-- Update Logs Section -->
      <div class="card" style="margin-top: 30px;">
        <h2 style="margin-bottom: 20px;">üìã Hist√≥ria aktualiz√°ci√≠</h2>
        <button onclick="loadUpdateLogs()" style="margin-bottom: 20px;">üîÑ Obnovi≈•</button>

        <div style="overflow-x: auto;">
          <table id="updateLogsTable">
            <thead>
              <tr>
                <th>D√°tum</th>
                <th>Pou≈æ√≠vateƒæ</th>
                <th>Spracovan√©</th>
                <th>√öspe≈°n√©</th>
                <th>Chyby</th>
                <th>Typ</th>
                <th>Detail</th>
              </tr>
            </thead>
            <tbody id="updateLogsTableBody">
              <tr>
                <td colspan="7" style="text-align: center; color: #94a3b8;">
                  Naƒç√≠tavam hist√≥riu...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Change Role Modal -->
  <div id="roleModal" class="modal">
    <div class="modal-content">
      <h2>Zmeni≈• rolu pou≈æ√≠vateƒæa</h2>
      <p style="margin-bottom: 20px; color: #64748b;" id="modalUserEmail"></p>

      <div class="form-group">
        <label>Nov√° rola:</label>
        <select id="newRoleSelect">
          <option value="standard">Standard (20 polo≈æiek, 1x update/mesiac)</option>
          <option value="premium">Premium (neobmedzen√©, 2x update/mesiac)</option>
          <option value="admin">Admin (neobmedzen√©, 2x update/mesiac + admin pr√≠stup)</option>
        </select>
      </div>

      <div class="modal-actions">
        <button onclick="closeModal()">Zru≈°i≈•</button>
        <button onclick="confirmRoleChange()">Ulo≈æi≈•</button>
      </div>
    </div>
  </div>

  <!-- Edit Next Update Modal -->
  <div id="updateDateModal" class="modal">
    <div class="modal-content">
      <h2>Zmeni≈• d√°tum najbli≈æ≈°ej aktualiz√°cie</h2>
      <p style="margin-bottom: 20px; color: #64748b;" id="modalUpdateUserEmail"></p>

      <div class="form-group">
        <label>Nov√Ω d√°tum a ƒças:</label>
        <input type="datetime-local" id="newUpdateDateInput" style="width: 100%; padding: 10px 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 14px;">
      </div>

      <div class="modal-actions">
        <button onclick="closeUpdateDateModal()">Zru≈°i≈•</button>
        <button onclick="confirmUpdateDateChange()">Ulo≈æi≈•</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, doc, getDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { getFunctions, httpsCallable } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBlAhlya-NNp8gCxGPBIPxxCgDa6l9AXo8",
      authDomain: "your-card-collection-2026.firebaseapp.com",
      projectId: "your-card-collection-2026",
      storageBucket: "your-card-collection-2026.firebasestorage.app",
      messagingSenderId: "620171462959",
      appId: "1:620171462959:web:28ecb209a009d16db679da"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const functions = getFunctions(app, 'us-central1');
    const googleProvider = new GoogleAuthProvider();

    let currentUser = null;
    let selectedUserId = null;

    // Auth state observer
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        document.getElementById('loginSection').style.display = 'block';
        document.getElementById('adminPanel').style.display = 'none';
        return;
      }

      currentUser = user;

      // Check if user is admin
      const userDoc = await getDoc(doc(db, 'users', user.uid));
      if (!userDoc.exists() || userDoc.data().role !== 'admin') {
        const loginStatus = document.getElementById('loginStatus');
        loginStatus.className = 'status error';
        loginStatus.style.display = 'block';
        loginStatus.innerHTML = '<strong>‚ùå Pr√≠stup zamietnut√Ω</strong><br>Nem√°te admin opr√°vnenia.';
        return;
      }

      // Show admin panel
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('adminPanel').style.display = 'block';
      document.getElementById('adminEmail').textContent = user.email;

      // Load users
      await loadUsers();
    });

    window.loginWithGoogle = async function() {
      const status = document.getElementById('loginStatus');
      try {
        status.className = 'status loading';
        status.style.display = 'block';
        status.innerHTML = '<strong>‚è≥ Prihlasovanie...</strong>';
        await signInWithPopup(auth, googleProvider);
      } catch (error) {
        console.error('Login error:', error);
        status.className = 'status error';
        status.innerHTML = `<strong>‚ùå Chyba pri prihl√°sen√≠:</strong><br><code>${error.message}</code>`;
      }
    };

    window.logout = async function() {
      await signOut(auth);
    };

    window.loadUsers = async function() {
      const status = document.getElementById('status');
      const tbody = document.getElementById('usersTableBody');

      status.className = 'status loading';
      status.innerHTML = '<strong>üîÑ Naƒç√≠tavam pou≈æ√≠vateƒæov...</strong>';

      try {
        const getAllUsers = httpsCallable(functions, 'getAllUsersV2');
        const result = await getAllUsers();
        const users = result.data.users;

        // Update stats
        document.getElementById('totalUsers').textContent = users.length;
        document.getElementById('premiumUsers').textContent = users.filter(u => u.role === 'premium').length;
        document.getElementById('totalCards').textContent = users.reduce((sum, u) => sum + u.currentCardCount, 0);

        // Update table
        tbody.innerHTML = '';
        users.forEach(user => {
          const tr = document.createElement('tr');
          const nextUpdate = user.nextUpdateDate ? new Date(user.nextUpdateDate).toLocaleString('sk-SK') : 'N/A';
          tr.innerHTML = `
            <td>${user.email || user.displayName || user.id}</td>
            <td><span class="role-badge role-${user.role}">${user.role}</span></td>
            <td><strong>${user.currentCardCount}</strong></td>
            <td>${user.cardLimit === 999999 ? '‚àû' : user.cardLimit}</td>
            <td>${user.updateIntervalDays} dn√≠</td>
            <td>
              ${nextUpdate}
              <button onclick="openUpdateDateModal('${user.id}', '${user.email}', '${user.nextUpdateDate || ''}')" style="margin-left: 5px; padding: 4px 8px; font-size: 12px;">‚úèÔ∏è</button>
            </td>
            <td>${user.createdAt ? new Date(user.createdAt).toLocaleDateString('sk-SK') : 'N/A'}</td>
            <td>
              <button onclick="triggerUpdateNow('${user.id}', '${user.email}')" style="background: #10b981; margin-bottom: 5px;">‚ñ∂Ô∏è Spusti≈• update</button><br>
              <button onclick="openRoleModal('${user.id}', '${user.email}', '${user.role}')">Zmeni≈• rolu</button>
            </td>
          `;
          tbody.appendChild(tr);
        });

        status.className = 'status success';
        status.innerHTML = `<strong>‚úÖ Naƒç√≠tan√Ωch ${users.length} pou≈æ√≠vateƒæov</strong>`;
        setTimeout(() => { status.innerHTML = ''; }, 3000);
      } catch (error) {
        console.error('Error loading users:', error);
        status.className = 'status error';
        status.innerHTML = `<strong>‚ùå Chyba:</strong> ${error.message}`;
      }
    };

    window.openRoleModal = function(userId, email, currentRole) {
      selectedUserId = userId;
      document.getElementById('modalUserEmail').textContent = email;
      document.getElementById('newRoleSelect').value = currentRole;
      document.getElementById('roleModal').classList.add('active');
    };

    window.closeModal = function() {
      document.getElementById('roleModal').classList.remove('active');
      selectedUserId = null;
    };

    window.confirmRoleChange = async function() {
      if (!selectedUserId) return;

      const newRole = document.getElementById('newRoleSelect').value;
      const status = document.getElementById('status');

      status.className = 'status loading';
      status.innerHTML = '<strong>‚è≥ Men√≠m rolu...</strong>';

      try {
        const updateUserRole = httpsCallable(functions, 'updateUserRoleV2');
        await updateUserRole({ targetUserId: selectedUserId, newRole: newRole });

        status.className = 'status success';
        status.innerHTML = `<strong>‚úÖ Rola √∫spe≈°ne zmenen√° na ${newRole}</strong>`;

        closeModal();
        await loadUsers();

        setTimeout(() => { status.innerHTML = ''; }, 3000);
      } catch (error) {
        console.error('Error updating role:', error);
        status.className = 'status error';
        status.innerHTML = `<strong>‚ùå Chyba:</strong> ${error.message}`;
      }
    };

    // Update Date Modal functions
    window.openUpdateDateModal = function(userId, email, currentDate) {
      selectedUserId = userId;
      document.getElementById('modalUpdateUserEmail').textContent = email;

      // Convert Firebase timestamp to datetime-local format
      if (currentDate) {
        const date = new Date(currentDate);
        const localDatetime = new Date(date.getTime() - date.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
        document.getElementById('newUpdateDateInput').value = localDatetime;
      }

      document.getElementById('updateDateModal').classList.add('active');
    };

    window.closeUpdateDateModal = function() {
      document.getElementById('updateDateModal').classList.remove('active');
      selectedUserId = null;
    };

    window.confirmUpdateDateChange = async function() {
      if (!selectedUserId) return;

      const newDatetime = document.getElementById('newUpdateDateInput').value;
      if (!newDatetime) {
        alert('Pros√≠m vyber d√°tum a ƒças');
        return;
      }

      const status = document.getElementById('status');

      status.className = 'status loading';
      status.innerHTML = '<strong>‚è≥ Men√≠m d√°tum aktualiz√°cie...</strong>';

      try {
        const updateNextUpdateDate = httpsCallable(functions, 'updateNextUpdateDateV2');
        await updateNextUpdateDate({
          targetUserId: selectedUserId,
          nextUpdateDate: new Date(newDatetime).toISOString()
        });

        status.className = 'status success';
        status.innerHTML = `<strong>‚úÖ D√°tum aktualiz√°cie √∫spe≈°ne zmenen√Ω</strong>`;

        closeUpdateDateModal();
        await loadUsers();

        setTimeout(() => { status.innerHTML = ''; }, 3000);
      } catch (error) {
        console.error('Error updating date:', error);
        status.className = 'status error';
        status.innerHTML = `<strong>‚ùå Chyba:</strong> ${error.message}`;
      }
    };

    // Trigger update now function
    window.triggerUpdateNow = async function(userId, email) {
      const status = document.getElementById('status');

      status.className = 'status loading';
      status.innerHTML = `<strong>‚è≥ Sp√∫≈°≈•am aktualiz√°ciu pre ${email}...</strong>`;

      try {
        const updateUserCollection = httpsCallable(functions, 'updateUserCollectionV2');
        const result = await updateUserCollection({ userId: userId });

        // Update started in background - poll status
        status.innerHTML = `<strong>‚è≥ Aktualiz√°cia prebieha na pozad√≠...</strong><br><small>Sledovanie postupu...</small>`;

        // Poll status document every 2 seconds
        const statusRef = doc(db, 'updateStatus', userId);
        let unsubscribe = null;

        unsubscribe = onSnapshot(statusRef, (docSnap) => {
          if (!docSnap.exists()) return;

          const statusData = docSnap.data();

          if (statusData.status === 'processing') {
            status.className = 'status loading';
            status.innerHTML = `
              <strong>‚è≥ Aktualiz√°cia prebieha...</strong><br>
              Email: ${email}<br>
              Spracovan√©: ${statusData.successCount + statusData.failCount} / ${statusData.cardsProcessed || '?'}<br>
              ‚úì √öspe≈°ne: <strong style="color: #10b981;">${statusData.successCount || 0}</strong><br>
              ${statusData.failCount > 0 ? `‚úó Chyby: <strong style="color: #ef4444;">${statusData.failCount}</strong>` : ''}
            `;
          } else if (statusData.status === 'completed') {
            status.className = 'status success';
            status.innerHTML = `
              <strong>‚úÖ Aktualiz√°cia dokonƒçen√°!</strong><br>
              Email: ${email}<br>
              Celkom polo≈æiek: ${statusData.cardsProcessed || 0}<br>
              ‚úì √öspe≈°ne aktualizovan√Ωch: <strong style="color: #10b981;">${statusData.successCount || 0}</strong><br>
              ${statusData.failCount > 0 ? `‚úó Nepodarilo sa: <strong style="color: #ef4444;">${statusData.failCount}</strong><br>` : ''}
              ${statusData.failCount > 0 ? '<small style="color: #64748b;">Polo≈æky bez v√Ωsledkov z eBay m√¥≈æe≈° upravi≈• manu√°lne v zbierke.</small>' : ''}
            `;

            // Stop listening
            if (unsubscribe) unsubscribe();

            // Reload users
            loadUsers();

            setTimeout(() => { status.innerHTML = ''; }, 8000);
          } else if (statusData.status === 'error') {
            status.className = 'status error';
            status.innerHTML = `<strong>‚ùå Chyba pri aktualiz√°cii:</strong><br><code>${statusData.error || 'Unknown error'}</code>`;

            // Stop listening
            if (unsubscribe) unsubscribe();
          }
        });

      } catch (error) {
        console.error('Error triggering update:', error);
        status.className = 'status error';
        status.innerHTML = `<strong>‚ùå Chyba pri aktualiz√°cii:</strong><br><code>${error.message}</code>`;
      }
    };

    window.refreshExchangeRatesNow = async function() {
      const status = document.getElementById('status');

      status.className = 'status loading';
      status.innerHTML = '<strong>‚è≥ Aktualizujem ECB kurzy...</strong>';

      try {
        const refreshRates = httpsCallable(functions, 'refreshExchangeRatesNowV2');
        const result = await refreshRates();
        const asOf = result.data?.asOf ? new Date(result.data.asOf).toLocaleDateString('sk-SK') : 'N/A';

        status.className = 'status success';
        status.innerHTML = `<strong>‚úÖ ECB kurzy aktualizovan√©</strong><br>As of: ${asOf}`;
        setTimeout(() => { status.innerHTML = ''; }, 4000);
      } catch (error) {
        console.error('Error refreshing ECB rates:', error);
        status.className = 'status error';
        status.innerHTML = `<strong>‚ùå Chyba pri aktualiz√°cii kurzov:</strong><br><code>${error.message}</code>`;
      }
    };
  </script>
</body>
</html>
